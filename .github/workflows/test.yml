name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  standalone_test:
    name: Generic C++ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-standalone

      - name: Configure CMake
        # CMAKE_<LANG>_COMPILER_LAUNCHER で ccache を有効化
        run: >
          cmake -B build
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_FOR_ROS2=OFF
          -DBUILD_TESTS=ON
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build --config Release

      - name: Test
        working-directory: build
        run: ctest -C Release --output-on-failure

  ros2_test:
    name: ROS 2 Humble
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      # ROS 2 環境のセットアップ
      - uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble

      # ビルドとテスト (colcon)
      # rosdep install, colcon build, test を一括で行う公式推奨アクション
      - uses: ros-tooling/action-ros-ci@v0.3
        with:
          package-name: gn10_can
          target-ros2-distro: humble
          # colcon build --cmake-args ... に渡される引数
          colcon-defaults: |
            {
              "build": {
                "cmake-args": ["-DBUILD_FOR_ROS2=ON"]
              }
            }
          # コードカバレッジやリンターもチェック可能（必要に応じてON）
          import-token: ${{ secrets.GITHUB_TOKEN }}